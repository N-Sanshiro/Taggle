<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Taggle - 天気</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body data-page="weather">

  <div class="panel" style="display:flex; justify-content:center; align-items:flex-start; min-height:100vh; padding-top:20px;">
    <div class="modal-content weather-card" role="region" aria-label="天気カード" style="max-width:360px; width:100%;">

      <div class="weather-head">
        <h2 id="wxTitle" style="margin:0;">---の現在の天気</h2>
      </div>

      <!-- タブ状の切替ボタン -->
      <div class="wx-tabs" role="tablist" aria-label="天気表示切替">
        <button id="btnToday" class="wx-tab" role="tab" aria-selected="true" aria-pressed="true">今日</button>
        <button id="btnTomorrow" class="wx-tab" role="tab" aria-selected="false" aria-pressed="false">明日</button>
      </div>

      <!-- ページ領域（ボタンで切替） -->
      <div id="wxPages" aria-live="polite">
        <!-- 今日 -->
        <section id="pageToday" class="wx-page" role="tabpanel" aria-labelledby="btnToday">
          <div id="wxIconToday" class="wx-hero" style="position:static; text-align:center; font-size:100px; margin:10px 0;">⛅</div>
          <ul class="wx-kv" style="font-size:1.05rem;">
            <li>天気：<b id="wxDescToday">—</b></li>
            <li>気温：<b id="wxTempToday">—</b></li>
            <li>湿度：<b id="wxHumToday">—</b></li>
          </ul>
          <div id="wxAdviceToday" class="wx-advice" style="font-size:1.00rem;">—</div>
        </section>

        <!-- 明日 -->
        <section id="pageTomorrow" class="wx-page" role="tabpanel" aria-labelledby="btnTomorrow" hidden>
          <div id="wxIconTomorrow" class="wx-hero" style="position:static; text-align:center; font-size:100px; margin:10px 0;">⛅</div>
          <ul class="wx-kv" style="font-size:1.05rem;">
            <li>天気：<b id="wxDescTomorrow">—</b></li>
            <li>最高/最低：<b id="wxTempTomorrow">—</b></li>
            <li>降水：<b id="wxRainTomorrow">—</b></li>
          </ul>
          <div id="wxAdviceTomorrow" class="wx-advice" style="font-size:1.00rem;">—</div> <!-- ← hidden を外す -->
        </section>
      </div>

    </div>
  </div>

  <!-- 下の閉じるボタン -->
  <div class="footer-row">
    <a href="index.html" class="btn-close" aria-label="閉じる">
      <svg class="icon-x" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" fill="none"/>
      </svg>
    </a>
  </div>

  <script src="app.js"></script>
  <script>
  // regions から {prefecture, latitude, longitude, timezone} を取得
  async function getUserRegion() {
    const fallback = { lat: 34.06583, lon: 134.55944, tz: 'Asia/Tokyo', prefecture: '徳島県' };
    try {
      const r = await fetch('../api/get_region.php', { credentials: 'same-origin' });
      const js = await r.json();
      if (!js.ok || !js.row) return fallback;

      const row = js.row;
      return {
        lat: parseFloat(row.latitude) || fallback.lat,
        lon: parseFloat(row.longitude) || fallback.lon,
        tz: row.timezone || fallback.tz,
        prefecture: row.prefecture || fallback.prefecture
      };
    } catch {
      return fallback;
    }
  }

  // Open-Meteo API
  async function fetchWeather(lat, lon, tz) {
    const url =
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`
      + `&current=temperature_2m,relative_humidity_2m,weather_code`
      + `&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum`
      + `&timezone=${encodeURIComponent(tz)}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error('天気データの取得に失敗しました');
    return r.json();
  }

  // 天気データを画面に反映
  async function fillWeather() {
    const region = await getUserRegion();
    const data = await fetchWeather(region.lat, region.lon, region.tz);
    const area = region.prefecture;

    // タイトル変更
    const titleEl = document.getElementById('wxTitle');
    titleEl.textContent = `${area}の現在の天気`;

    // 今日
    const t  = Math.round(data.current.temperature_2m);
    const h  = data.current.relative_humidity_2m;
    const wc = data.current.weather_code;
    document.getElementById('wxIconToday').textContent = WMO_ICON(wc);
    document.getElementById('wxDescToday').textContent = (WMO && WMO[wc]) ? WMO[wc] : '—';
    document.getElementById('wxTempToday').textContent = `${t}℃`;
    document.getElementById('wxHumToday').textContent  = `${h}%`;
    renderAdvice(document.getElementById('wxAdviceToday'),    buildAdviceToday(t, h, wc));

    // 明日
    const i = 1;
    const wc2 = data.daily.weather_code[i];
    const tmax = Math.round(data.daily.temperature_2m_max[i]);
    const tmin = Math.round(data.daily.temperature_2m_min[i]);
    const rain = data.daily.precipitation_sum[i];
    document.getElementById('wxIconTomorrow').textContent = WMO_ICON(wc2);
    document.getElementById('wxDescTomorrow').textContent = (WMO && WMO[wc2]) ? WMO[wc2] : '—';
    document.getElementById('wxTempTomorrow').textContent = `${tmax}℃ / ${tmin}℃`;
    document.getElementById('wxRainTomorrow').textContent = `${rain} mm`;
    renderAdvice(document.getElementById('wxAdviceTomorrow'), buildAdviceTomorrow(tmax, rain));

    // タブの初期化
    initTabs(area);
  }

  // タブ切替
  function initTabs(area) {
    const btnToday = document.getElementById('btnToday');
    const btnTomorrow = document.getElementById('btnTomorrow');
    const pageToday = document.getElementById('pageToday');
    const pageTomorrow = document.getElementById('pageTomorrow');
    const titleEl = document.getElementById('wxTitle');

    function setTitle(i) {
      if (i === 0) {
        titleEl.textContent = `${area}の現在の天気`;
      } else {
        const d = new Date(Date.now() + 86400000);
        titleEl.textContent = `${area}の明日（${d.getMonth() + 1}/${d.getDate()}）の天気`;
      }
    }

    function go(i){
  const isToday = i === 0;

  pageToday.hidden    = !isToday;
  pageTomorrow.hidden =  isToday;

  // 選択状態を両方のARIA属性で同期
  btnToday.setAttribute('aria-selected', String(isToday));
  btnTomorrow.setAttribute('aria-selected', String(!isToday));
  btnToday.setAttribute('aria-pressed',  String(isToday));
  btnTomorrow.setAttribute('aria-pressed', String(!isToday));

  // 保険：クラスでも切替（CSSに .wx-tab.is-active のルールあり）
  btnToday.classList.toggle('is-active',  isToday);
  btnTomorrow.classList.toggle('is-active', !isToday);

  setTitle(i);
}

    btnToday.addEventListener('click', () => go(0));
    btnTomorrow.addEventListener('click', () => go(1));
    go(0);
  }

  // 実行
  (async () => {
    try {
      await fillWeather();
    } catch (e) {
      document.getElementById('wxAdviceToday').textContent = e?.message || String(e);
    }
  })();
</script>

</body>
</html>